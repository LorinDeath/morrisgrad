---

// Используем import.meta.glob для создания списка песен при сборке.
// Это работает в SSR и не требует сканирования диска (fs).
// ВАЖНО: Переместите папку music из public в src (должно быть src/music)
const musicFiles = import.meta.glob('/src/music/*.mp3', { eager: true });

const songs = Object.entries(musicFiles).map(([filePath, module]) => {
  // @ts-ignore - Vite возвращает модуль, где default — это URL файла
  const url = module.default;
  // Извлекаем имя файла из пути
  const name = filePath.split('/').pop()?.replace('.mp3', '') || 'Неизвестный трек';
  return { name, url };
});

// Если музыки нет, добавим заглушку, чтобы не ломалось
if (songs.length === 0) {
  songs.push({ name: "Тишина (добавьте файлы в src/music)", url: "" });
}
---

<!-- 
  transition:persist="radio-player" — это магия. 
  Astro запомнит этот элемент и не будет его перезагружать при переходе между страницами.
  Атрибут transition:name позволяет плавно перемещать его визуально.
-->
<div class="radio-player-wrapper" transition:persist="radio-player" transition:name="radio-morph">
  <div class="radio-interface">
    <div class="track-info">
      <span class="label">ON AIR:</span>
      <div class="marquee-container">
        <span id="track-name" class="marquee-content">Нажмите play чтобы включить местное радио</span>
      </div>
    </div>
    
    <div class="controls">
      <button id="play-btn" class="control-btn">▶</button>
      <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.5">
    </div>
  </div>

  <audio id="audio-element"></audio>

<script define:vars={{ songs }}>
  // Логика плеера
  const audio = document.getElementById('audio-element');
  const playBtn = document.getElementById('play-btn');
  const trackName = document.getElementById('track-name');
  const volumeSlider = document.getElementById('volume-slider');

  let isPlaying = false;
  let currentPlaylist = [...songs]; // Копия для перемешивания

  // Функция перемешивания (Fisher-Yates shuffle)
  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  function playNextRandom() {
    // Если список пуст или содержит только заглушку
    if (songs.length === 0 || (songs.length === 1 && songs[0].url === "")) {
      alert("Радио не нашло музыку. Убедитесь, что файлы лежат в src/music.");
      return;
    }

    // Если плейлист кончился, мешаем заново
    if (currentPlaylist.length === 0) {
      currentPlaylist = shuffle([...songs]);
    }
    
    const song = currentPlaylist.pop();
    if (!song.url) return; // Защита от пустых

    trackName.textContent = song.name;
    audio.src = song.url;
    audio.play().then(() => {
      isPlaying = true;
      playBtn.textContent = "❚❚";
    }).catch(e => console.log("Автовоспроизведение заблокировано браузером", e));
  }

  // Обработчики событий
  playBtn.addEventListener('click', () => {
    if (!audio.src) {
      playNextRandom();
    } else if (audio.paused) {
      audio.play();
      playBtn.textContent = "❚❚";
    } else {
      audio.pause();
      playBtn.textContent = "▶";
    }
  });

  volumeSlider.addEventListener('input', (e) => {
    audio.volume = e.target.value;
  });

  // Когда песня закончилась — включаем следующую
  audio.addEventListener('ended', playNextRandom);

  // Инициализация (первый запуск перемешивания)
  currentPlaylist = shuffle([...songs]);
</script>
</div>

<style>
  .radio-player-wrapper {
    background: rgba(26, 11, 46, 0.95);
    border: 1px solid var(--accent-gold);
    border-radius: 8px;
    padding: 10px 20px;
    box-shadow: 0 0 15px rgba(160, 32, 240, 0.3);
    backdrop-filter: blur(5px);
    width: 100%;
    box-sizing: border-box;
  }

  .radio-interface {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 15px;
  }

  .track-info {
    display: flex;
    align-items: center;
    gap: 10px;
    overflow: hidden;
    flex: 1;
  }

  .label {
    color: var(--accent-gold);
    font-weight: bold;
    font-size: 0.8rem;
    white-space: nowrap;
  }

  .marquee-container {
    flex: 1;
    overflow: hidden;
    white-space: nowrap;
    position: relative;
    mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
    -webkit-mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
  }

  .marquee-content {
    display: inline-block;
    padding-left: 100%;
    animation: marquee 15s linear infinite;
  }

  @keyframes marquee {
    0% { transform: translate3d(0, 0, 0); }
    100% { transform: translate3d(-100%, 0, 0); }
  }

  #track-name {
    color: #fff;
    font-family: 'Exo 2', sans-serif;
  }

  .controls {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .control-btn {
    background: none;
    border: 1px solid var(--energy-purple);
    color: var(--accent-gold);
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
  }

  .control-btn:hover {
    background: var(--energy-purple);
    color: #fff;
  }

  input[type=range] {
    width: 80px;
    accent-color: var(--accent-gold);
  }
</style>